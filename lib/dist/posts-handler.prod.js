"use strict";var pug=require("pug"),Cookies=require("cookies"),util=require("./handler-util"),Post=require("./post"),trackingIdKey="tracking_id";function handle(t,n){var o=new Cookies(t,n);switch(addTrackingCookie(o),t.method){case"GET":n.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),Post.findAll({order:[["id","DESC"]]}).then(function(e){n.end(pug.renderFile("./views/posts.pug",{posts:e})),console.info("閲覧されました: user: ".concat(t.user,", ")+"trackingId: ".concat(o.get(trackingIdKey),",")+"remoteAddress: ".concat(t.connection.remoteAddress," ")+"userAgent: ".concat(t.headers["user-agent"]))});break;case"POST":var r=[];t.on("data",function(e){r.push(e)}).on("end",function(){r=Buffer.concat(r).toString();var e=decodeURIComponent(r).split("content=")[1];console.info("投稿されました: "+e),Post.create({content:e,trackingCookie:o.get(trackingIdKey),postedBy:t.user}).then(function(){handleRedirectPosts(t,n)})});break;default:util.handleBadRequest(t,n)}}function addTrackingCookie(e){if(!e.get(trackingIdKey)){var t=Math.floor(Math.random()*Number.MAX_SAFE_INTEGER),n=new Date((new Date).getTime()+864e5);e.set(trackingIdKey,t,{expires:n})}}function handleRedirectPosts(e,t){t.writeHead(303,{Location:"/posts"}),t.end()}module.exports={handle:handle};